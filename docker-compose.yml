# ─────────────────────────────────────────────────────────────────────────────
# docker-compose.yml — HyperLiquidMM Full Stack
#
# All services in one place: Redis → Engine → Screener
# Single command to start everything:
#
#   Shadow mode (safe, default):
#     docker compose up -d
#
#   Live mode (requires explicit override):
#     MM_SHADOW_MODE=false docker compose up -d
#
#   View logs:
#     docker compose logs -f
#     docker compose logs -f mm-engine      # Engine only
#     docker compose logs -f mm-screener    # Screener only
#
#   Stop everything:
#     docker compose down
#
# Credentials:
#   All secrets come from backend/mm-engine-rs/.env — never committed to git.
#   Required keys: HL_ADDRESS, HL_PRIVATE_KEY
#   Optional:      REDIS_URL (defaults to internal mm-redis service)
# ─────────────────────────────────────────────────────────────────────────────

services:

  # ── Redis: Screener ↔ Engine IPC ──────────────────────────────────────────
  mm-redis:
    image: redis:7-alpine
    container_name: mm_redis
    ports:
      - "6380:6379"   # Host port 6380 avoids clash with directional bot's Redis on 6379
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── Market Maker Engine (Rust) ─────────────────────────────────────────────
  mm-engine:
    build:
      context: ./backend/mm-engine-rs
      dockerfile: Dockerfile
    container_name: mm_engine
    env_file:
      - ./backend/mm-engine-rs/.env    # HL_ADDRESS, HL_PRIVATE_KEY, etc.
    depends_on:
      mm-redis:
        condition: service_healthy
    environment:
      - RUST_LOG=info
      - REDIS_URL=redis://mm-redis:6379
      - MM_SHADOW_MODE=${MM_SHADOW_MODE:-true}   # Default: shadow. Override to go live.
      - MM_HARVEST_TICKS=true
    restart: unless-stopped
    volumes:
      # Tick data persisted on the host — survives container restarts/rebuilds.
      # This is your growing proprietary dataset.
      # Shared with mm-screener so it can calibrate spreads from historical ticks.
      - mm_tick_data:/app/data/ticks
      # Also persist to host for backtesting access outside of Docker
      - ./data/mm_ticks:/app/data/host_ticks
      # Engine logs
      - ./logs/mm:/app/logs

  # ── Python Screener (asset selection + per-asset config publisher) ──────────
  # Publishes Vec<MmAssetConfig> to Redis channel mm:asset_config every 60s.
  # Fetches live market data from Hyperliquid API, scores coins by Maker Edge,
  # and computes per-coin spread calibration.
  mm-screener:
    build:
      context: .
      dockerfile: scripts/Dockerfile.mm_screener
    container_name: mm_screener
    env_file:
      - ./backend/mm-engine-rs/.env
    depends_on:
      mm-redis:
        condition: service_healthy
      mm-engine:
        condition: service_started
    environment:
      - REDIS_URL=redis://mm-redis:6379
    restart: unless-stopped
    volumes:
      # Mount shared tick data volume (read-only) for spread calibration
      - mm_tick_data:/app/data/ticks:ro
      # Screener logs
      - ./logs/mm:/app/logs

# ── Named volumes ──────────────────────────────────────────────────────────
# Named volume ensures tick data persists across container rebuilds
# and is shared between engine (writer) and screener (reader).
volumes:
  mm_tick_data:
    driver: local
